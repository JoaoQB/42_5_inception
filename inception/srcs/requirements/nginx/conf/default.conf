# HTTPS server block with TLS and HTTP/2
server {

# --- Fundamental Settings ---

# Listen on HTTPS port 443 with HTTP/2 enabled for improved performance
listen 443 ssl http2;
listen [::]:443 ssl http2;

# TLS 1.2 or 1.3 only
ssl_protocols TLSv1.2 TLSv1.3;

# SSL certificate and private key used for HTTPS encryption
# These are self-signed "snake-oil" certificates generated automatically by the OS (via the ssl-cert package).
# They are useful for local development or internal testing but are **not trusted** by browsers or clients in production.
# For real-world deployments, always replace these with valid certificates from a trusted Certificate Authority (CA),
# such as those issued by Let's Encrypt or a commercial provider.
ssl_certificate /etc/ssl/certs/nginx-selfsigned.crt;
ssl_certificate_key /etc/ssl/private/nginx-selfsigned.key;

# The domain names this server block will respond to
server_name jqueijo-.42.fr www.jqueijo-.42.fr;

# Define the default file to serve if no filename is specified
index index.html index.php;

# Set the document root directory for this server block
root /var/www/html;

# Location of error log file
error_log  /var/log/nginx/error.log;

# Location of access log file
access_log /var/log/nginx/access.log;

# Serve static files directly
location / {
  # Try to serve file, then directory
  try_files $uri $uri/ =404;
}

# Match PHP file requests (case-sensitive)
location ~ \.php$ {
  # Return 404 if the requested file is not found
  try_files $uri =404;
  # Split URI at `.php` and the following path (used by some PHP apps like Laravel, Symfony)
  fastcgi_split_path_info ^(.+\.php)(/.+)$;
  # Send the request to the PHP-FPM service
  fastcgi_pass wordpress:9000;
  # Include default FastCGI parameters (e.g., SCRIPT_FILENAME)
  include fastcgi_params;
  # Tell PHP-FPM the full path of the script
  fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
  # Optional: pass PATH_INFO to PHP, used in some routing setups
  fastcgi_param PATH_INFO $fastcgi_path_info;
}

# Block access to hidden dotfiles
location ~ /\.ht {
  deny all;
}

# --- Optional but Recommended Settings ---

# Cache SSL sessions to speed up repeated connections
ssl_session_cache shared:SSL:10m;
# Session cache lifetime
ssl_session_timeout 10m;

# HSTS (ngx_http_headers_module is required) (63072000 seconds)
# Enable HTTP Strict Transport Security (HSTS) to force HTTPS for 2 years
add_header Strict-Transport-Security "max-age=63072000" always;

# Disable session tickets for better security (prevents replay attacks)
ssl_session_tickets off;

# # DNS resolver for OCSP stapling and other name resolutions
# resolver 8.8.8.8;

# --- Optimization Settings ---

# Timeout for keep-alive connections (clients can reuse connection)
keepalive_timeout   70;
}

# # Redirect all HTTP traffic to HTTPS
# # Ensures all traffic is securely encrypted as required
# server {
# # Listen on port 80 for both IPv4 and IPv6
# listen 80;
# listen [::]:80;
# # Domain name
# server_name jqueijo-.42.fr;

# # Redirect all requests to the same URL but with HTTPS scheme
# return 301 https://$host$request_uri;
# }
